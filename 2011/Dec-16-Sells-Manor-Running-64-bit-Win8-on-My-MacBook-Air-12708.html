<!--
Date: 12/16/2011 2:26:00 PM  -08:00
Permalink: 12708
Disqus: 12708
Tags: spout
-->
<h1>Sells Manor: Running 64-bit Win8 on My MacBook Air</h1>
<p><img style="margin: 0px 0px 5px 5px; display: inline; float: right" align="right" src="http://cdn.sitetrail.com/wp-content/uploads/2011/08/Apple-and-Microsoft.jpg" width="240" height="202" />With the exception of <a href="http://channel9.msdn.com/events/BUILD/BUILD2011/BPS-1006">//build/</a>, I haven’t really been a public part of the Microsoft developer community for about a year. So, to make up for some lost time, I’m giving a talk about some of the //build/ bits at <a href="http://www.padnug.org/">the Portland Area .NET User Group</a> first thing in the new year. This means that I need a running installation of the Windows 8 Developer Preview on my new laptop, ‘cuz <a href="http://microsoft.com">THE MAN</a> took my old laptop back when I handed in my badge (although, to be fair, they paid for it in the first place : ).</p>  <p>My constraints were as follows:</p>  <ul>   <li><strong>I really like </strong><a href="http://www.hanselman.com/blog/LessVirtualMoreMachineWindows7AndTheMagicOfBootToVHD.aspx"><strong>boot-to-VHD</strong></a><strong>. </strong>I find that any other kind of virtualization technology slows an OS down enough that it negatively affects any talk I would give. </li>    <li><strong>I have an existing VHD </strong>I wanted to reuse with Win8 and VS11 installed and running just fine already. </li>    <li><strong>I am running it on a MacBook Air. </strong>It’s the big one with quad-core i7, 4GB of RAM and 256GB of SSD, so it’s got the muscle but it needs to drivers to make everything work properly. </li>    <li><strong>I’m running Windows 7 on my MacBook. </strong>The wonderful Boot Camp Assistant in MacOS makes it a snap to get Win7 up and running on a MacBook, but making it run with Win7 <em>and </em>Win8 is a special challenge. </li> </ul>  <p>So, with all of that in mind, of course I started with <a href="http://www.hanselman.com/blog/GuideToInstallingAndBootingWindows8DeveloperPreviewOffAVHDVirtualHardDisk.aspx">Hanselman’s Guide to Installing and Booting Windows 8 Developer Preview off a VHD</a> post. If you’re willing to build a new VHD, that’s the way to go. However, I was able to use the techniques I learned from that post, especially the comment section and a couple tips from my friend <a href="http://www.mcwtech.com/blogs/brianr/">Brian Randall</a> to make my existing Win8 VHD work. Some of this may work for you even if you don’t have a MacBook Air.</p>  <h2>Getting Windows 7 Running on my MacBook Air</h2>  <p>I started with a virginal MacBook and used the built in Boot Camp to create a Win7 partition, point to a Win7 Ultimate ISO I have on a network share for just these kinds of emergencies and get it installed and running. It wasn’t seamless, but <a href="http://tinyurl.com/7cx5dfk">Bing was helpful here to straighten out the curves</a>.</p>  <h2>Replacing the Boot Manager</h2>  <p>The way I like to create VHDs is via Windows Server 2008 and Hyper-V. Once I have the VHD, I drop it onto the <strong>c:\vhd </strong>folder on my computer, do a little bcdedit magic and boom: when I reboot, I’ve got a new entry from which to choose my OS of the moment.</p>  <p>However, Win8 doesn’t boot from the Win7 boot manager, so the first thing I needed to do (as implied by the comments in <a href="http://www.hanselman.com/blog/GuideToInstallingAndBootingWindows8DeveloperPreviewOffAVHDVirtualHardDisk.aspx">Scott’s post</a>) was use <strong>bcdboot </strong>to replace the Win7 book manager with the Win8 boot manager. To do that, boot into Win7 and fire up the Disk Management tool (Start | Run: diskmgmt.msc). Select your BOOTCAMP drive and choose Action | Attach VHD. Choose the path to your VHD and you’ll get another virtual disk:</p>  <p><a href="/public/post-images/12708-75.png"><img style="display: inline" title="image" alt="image" src="/public/post-images/12708-76.png" width="640" height="460" /></a></p>  <p>In my case, C was my Win7 Boot Camp HD and F was my Win8 VHD. Now, start an elevated command prompt and use <strong>bcdboot</strong> to replace the Win7 boot manager with the Win8 book manager.</p>  <p><img style="margin: 0px 0px 5px 5px; display: inline; float: right" align="right" src="http://www.hanselman.com/blog/content/binary/WindowsLiveWriter/FreeingupDiskSpaceunderWindowsVist_11C3B/works-on-my-machine-starburst_3.png" /></p>  <p><font color="#ff0000"></font></p>  <p><font color="#ff0000">DISCLAIMER: I’m stealing the “works on my machine” graphic from Hanselman’s site because this action replaces a shipping, maintained, supported boot manager with one that is still in “developer preview” mode. Make sure you have your computer backed up before you do this. I am a trained professional. Do not attempt this at home. All stunts performed on a closed course. Some assembly required. Void where prohibited. I’m just sayin’.</font></p>  <p><a href="/public/post-images/12708-77.png"><img style="display: inline" title="image" alt="image" src="/public/post-images/12708-78.png" width="640" height="277" /></a></p>  <p>Now that you’ve got the right boot manager in place, getting Win8 to boot requires bcdedit.</p>  <h2>Getting Windows 8 to Boot</h2>  <p><a href="http://www.hanselman.com/blog/LessVirtualMoreMachineWindows7AndTheMagicOfBootToVHD.aspx">Scott’s post on booting to VHD</a> involves bcdedit, which describes adding a new boot option in the “Setting up your Windows Boot Menu to boot to an Existing VHD” section:</p>  <p><a href="http://www.hanselman.com/blog/LessVirtualMoreMachineWindows7AndTheMagicOfBootToVHD.aspx"><img style="display: inline" title="image" alt="image" src="/public/post-images/12708-79.png" width="640" height="318" /></a></p>  <p>Use bcdedit to point to the Win8 VHD.</p>  <h2>Logging into Windows 8 on a MacBook</h2>  <p>Now when you boot your MacBook, you’ll choose to boot to your Windows partition as you always have (which should just happen automatically), but then the Win8 book manager will kick in and you choose your Windows 7 install or your new Windows 8 install. Booting into Windows 8 shows you the login screen as normal, but now you have another problem.</p>  <p>The MacBook keyboard comes without a Windows Delete button. Oh sure, it’s labeled “delete” in trendy lowercase letters, but it’s really the equivalent of the Windows Backspace button. And that’s a problem, because you need to press Ctrl+Alt+Del to log into Win8.</p>  <p>Of course, Apple thought of that, so they created the Boot Camp drivers for Windows that maps fn+delete to Delete, but you can only install them after you’ve logged in.</p>  <p>So how do you log into a MacBook without a Delete button? Easy. You attach an external USB keyboard, press that three-fingered salute and login as normal.</p>  <p>Once you’re in that first time, you can install the Boot Camp drivers and never have to use the external keyboard again.</p>  <h2>Installing the Boot Camp Drivers on Win8</h2>  <p>When I created the Boot Camp USB to install Win7, it came with a set of drivers in the WindowsSupport folder with a wonderful setup.exe that makes Windows run great on the MacBook. Unfortunately, when you try to run it, you get a message that says you can’t:</p>  <p><a href="/public/post-images/12708-80.png"><img style="display: inline" title="Untitled" alt="Untitled" src="/public/post-images/12708-81.png" width="640" height="315" /></a></p>  <p>If you <a href="http://tinyurl.com/cte4pe6">search the internet</a>, you can find folks that have gotten past this by tricking setup.exe into thinking it’s running on Win7, but you’ll also find that those tricks don’t seem to work for 64-bit installs on MacBook Air, i.e. the one I was doing. However, this is where Brian had another suggestion: you can edit the Boot Camp MSI itself.</p>  <p><img style="margin: 0px 0px 5px 5px; display: inline; float: right" align="right" src="http://www.hanselman.com/blog/content/binary/WindowsLiveWriter/FreeingupDiskSpaceunderWindowsVist_11C3B/works-on-my-machine-starburst_3.png" /><font color="#ff0000">DISCLAIMER: T</font><font color="#ff0000">his is something that I made work surprising well on my own personal MacBook Air, but I provide no guarantee that it won’t cause your computer to burst into flames on an international flight causing your body to be lost at sea. These techniques are not supported by Microsoft, Apple or </font><a href="http://ada.org"><font color="#ff0000">the American Dental Association</font></a><font color="#ff0000">. You’ve been warned.</font></p>  <p>You may wonder, “To what MSI is Mr. Sells referring?” And I answer: <strong>WindowsSupport\Drivers\Apple\<strong>BootCamp64.msi</strong></strong>. This is the 64-bit MSI with the check in it for Windows 7. To make it work for Windows 8, you need to edit the MSI and change the version number. And to do that, the easiest tool I know of is the unsupported, discontinued Orca MSI editor from Microsoft, <a href="http://www.technipages.com/download-orca-msi-editor.html">now hosted on technipages.com</a>. Running Orca allows you to edit <strong>BootCamp64.msi </strong>and change the Windows version part of the <strong>LaunchCondition </strong>from 601 (Windows 7) to 602 (Windows 8):</p>  <p><a href="/public/post-images/12708-82.png"><img style="display: inline" title="orca" alt="orca" src="/public/post-images/12708-83.png" width="640" height="265" /></a></p>  <p>Once you’ve changed this version, <strong>WindowsSupport\setup.exe </strong>seems to run just fine, installing the keyboard entries that allow you to login and the control panel that allows you to customize everything.</p>  <h2>Where Are We?</h2>  <p>Starting from a Boot Camp installation of Windows 7 on my MacBook Air, I showed you how I was able to get Windows 8 booting from a VHD. It wasn’t pretty and it required tips from all over the internet. I gather them here today so that future anthropologists will know how hard we worked to enable the coming of our robotic overlords. If you’re able to use these instructions to expedite their arrival, I’m sure they’ll take that into consideration when they’re sorting us into work details.</p>  <p>P.S. This post is dedicated to <a href="http://en.wikipedia.org/wiki/Jerry_Pournelle">Jerry Pournelle</a>. I used to pour over his Byte magazine column every month like he was the computer Sherlock Holmes.</p>  
