<!--
Date: 7/11/2014 10:45:54 PM  -08:00
Permalink: 12733
Disqus: 12733
Tags: spout
-->
<h1>Moving My Site to Azure: DNS & SSL</h1>
<p>This part 3 of a multi-part series on taking a real-world web site (mine) written to be hosted on an ISP (<a href="http://securewebs.com">securewebs.com</a>) and moving it to the cloud (Azure). The first two parts talked about <a href="/12731">moving my SQL Server instance to SQL Azure</a> and getting my legacy ASP.NET MVC 2 code running inside of Visual Studio 2013 and <a href="/12732">published to Azure</a>. In this installment, we’ll discuss how I configured DNS and SSL to work with my shiny new Azure web site.</p>  <h2>Configuring DNS</h2>  <p>Now that I have my site hosted on <a href="http://sellsbrothers.azurewebsites.net">http://sellsbrothers.azurewebsites.net</a>, I’d like to change my DNS entries for sellsbrothers.com and www.sellsbrothers.com to point to it. For some reason I don’t remember, I have my domain’s name servers pointed at microsoftonline.com and I used Office365 to manage them (it has something to do with my Office365 email account, but I’m not sure why that matters…). Anyway, in the Manage DNS section of the Office365 admin pages, there’s a place to enter various DNS record types. To start, I needed to add two CNAME records:</p>  <p><a href="/public/post-images/12733-236.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12733-237.png" width="646" height="72" /></a></p>  <p><em>The CNAME records needed to be awarded an IP address by Azure</em></p>  <p>&#160;</p>  <p><a href="http://en.wikipedia.org/wiki/CNAME_record">A CNAME record</a> is an alias to some other name. In this case, we’re aliasing the awveryify.sellsbrothers.com <a href="http://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a> (the Host name field is really just the part to the left of the domain name to which you’re adding records, sellsbrothers.com in this case). This awverify string is just a string that Azure needs to see before it will tell you the IP address that it’s assigned to you as a way to guarantee that you do, in fact, own the domain. The www host name maps to the Azure web site name, i.e. mapping www.sellsbrothers.com to sellsbrothers.azurewebsites.net. The other DNS record I need is an A record, which maps the main domain, i.e. sellsbrothers.com, to the Azure IP address, which I’ll have to add later once Azure tells me what it is.</p>  <p>After adding the awverify and www host names and waiting for the DNS changes to propagate (an hour or less in most cases), I fired up the configuration screen for my web site and chose the Manage Custom Domains dialog:</p>  <p><a href="/public/post-images/12733-238.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12733-239.png" width="646" height="476" /></a></p>  <p><em>Finding the IP address to use in configuring your DNS name server from Azure</em></p>  <p>&#160;</p>  <p>Azure provided the IP address after entering the www.sellsbrothers.com domain name. With this in hand, I needed to add the A record:</p>  <p><a href="/public/post-images/12733-240.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12733-241.png" width="646" height="98" /></a></p>  <p><em>Adding the Azure IP address to my DNS name servers</em></p>  <p>&#160;</p>  <p>An <a href="http://en.wikipedia.org/wiki/List_of_DNS_record_types">A record</a> is the way to map a host name to an IP address. The use of the @ means the undecorated domain, so I’m mapping sellsbrothers.com to the IP address for sellsbrothers.azurewebsites.net.</p>  <p>Now, this works, but it’s not quite what I wanted. What I really want to do, and what the Azure docs hint at, is to simply have a set of CNAME records, including one that maps the base domain name, i.e. sellsbrothers.com, to sellsbrothers.azurewebsites.net directly and let DNS figure out what the IP address is. This would allow me to tear down my web server and set it up again, letting Azure assign whatever IP address it wanted and without me being required to update my DNS A record if I ever need to do that. However, while I should be able to enter a CNAME record with a @ host name, mapping it to the Azure web site domain name, Office365 the DNS management UI won’t let me do it and Office365 support wasn’t able to help.</p>  <p>However, even if my DNS records weren’t future-proofed the way I’d like them to be, they certainly worked and now both sellsbrothers.com and www.sellsbrothers.com mapped to my new Azure web site, which is where those names are pointing as I write this.</p>  <p>However, there was one more feature I needed before I was done ported my site to Azure: secure posting to my blog, which requires an SSL certificate.</p>  <h2></h2>  <h2>Configuring Azure with SSL</h2>  <p>Once I had my domain name flipped over, I had one more feature I needed for my Azure-hosted web site to be complete – I needed to be able to make posts to my blog. I implemented <a href="http://bitworking.org/projects/atom/rfc5023.html">the AtomPub publishing protocol</a> for my web site years ago, mostly because it was a protocol with which I was very familiar and because it was one that <a href="http://en.wikipedia.org/wiki/Windows_Live_Writer">Windows Live Writer</a> supports. To make sure that only I could post to my web site, I needed to make sure that my user name and password didn’t transmit in the clear. The easiest way to make that happen was to enable HTTPS on my site using an SSL certificate. Of course, Azure supports HTTPS and SSL and the interface to make this happen is simple:</p>  <p><a href="/public/post-images/12733-242.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12733-243.png" width="646" height="455" /></a></p>  <p><em>Azure’s certificate update dialog for added an SSL cert to your web site</em></p>  <p>&#160;</p>  <p>Azure requires a file in the PKCS #12 format (generally using the .pfx file extension), which can be a container of several security-related objects, including a certificate. All of this is fine and dandy except that when you go to purchase your SSL cert, you’re not likely to get the file in pfx format, but in X.509 format (.cer or .crt file format). To translate the .crt file into a .pfx file, you need to generate a Certificate Signing Request (.csr) file with the right options so that you keep the private key (.key) file around for the conversion. For a good overview of the various SSL-related file types, <a href="http://blogs.msdn.com/b/kaushal/archive/2010/11/05/ssl-certificates.aspx">check out Kaushal Panday’s excellent blog post</a>.</p>  <p>Now, to actual dig into the nitty gritty, first you’re going to have to choose an SSL provider. Personally, I’m a cheapskate and don’t do any ecommerce on my site, so my needs were modest. I got myself a RapidSSL cert from <a href="http://namecheap.com">namecheap.com</a> that only did domain validation for $11/year. After making my choice, the process went smoothly. To get started, you pay your money and upload a Certificate Signing Request (.crs file). I tried a couple different ways to get a csr file, but the one that worked the best was <a href="http://slproweb.com/products/Win32OpenSSL.html">the openssl command line tool for Windows</a>. With that tool installed and a command console (running in admin mode) at the ready, you can follow along with the <a href="http://azure.microsoft.com/en-us/documentation/articles/web-sites-configure-ssl-certificate/#get-a-certificate-using-openssl">Get a certificate using OpenSSL</a> section of the Azure documentation on SSL certs and be in good shape.</p>  <p>Just one word of warning if you want to follow along with these instructions yourself: There’s a blurb in there about including intermediate certificates along with the cert for your site. For example, when I get my RapidSSL certificate, it came with a GeoTrust intermediate certificate. Due to <a href="http://stackoverflow.com/questions/24558174/error-uploading-ssl-certificate-to-windows-azure">a known issue</a>, when I tried to include the GeoTrust cert in my chain of certificates, Azure would reject it. Just dropping that intermediate cert on the floor worked for me, but your mileage may vary.</p>  <h2>Configuring for Windows Live Writer</h2>  <p>Once I have my SSL uploaded to Azure, now I can configure WLW securely for my new Azure-hosted blog:</p>  <p><a href="/public/post-images/12733-244.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12733-245.png" width="601" height="484" /></a></p>  <p><em>Adding a secure login for my Azure-hosted blog</em></p>  <p>&#160;</p>  <p>You’ll notice that I use HTTPS as the protocol to let WLW know I’d like it to use encrypted traffic when it’s transmitting my user name and password. The important part of the rest of the configuration is just about what kind of protocol you’d like to use, which is AtomPub in my case:</p>  <p><a href="/public/post-images/12733-246.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12733-247.png" width="601" height="484" /></a></p>  <p><em>Configuring WLW for the AtomPub Publishing protocol</em></p>  <p>&#160;</p>  <p>If you’re interested in a WLW-compatible implementation of AtomPub written for ASP.NET, you can <a href="https://github.com/csells/sb4">download the source to my site from github</a>.</p>  <h2>Where are we?</h2>  <p>Getting your site moved to Azure from an ISP involves more than just <a href="/12732">making sure you can deploy your code</a> – it also includes <a href="/12731">making sure your database will work in SQL Azure</a> and configuring your DNS and SSL settings as appropriate for your site’s new home.</p>  <p>At this point, I’ve gotten a web site that’s running well in the cloud, but in the spirit of the cloud, I’ve also got an aging comment system that I replaced with <a href="http://disqus.com/">Disqus</a>, a cloud-hosted commenting system, which is the subject of <a href="/12734">my next post</a>. Don’t miss it!</p>  
