<!--
Date: 7/17/2014 12:05:47 AM  -08:00
Permalink: 12734
Disqus: 12734
Tags: spout
-->
<h1>Moving My ASP.NET Web Site to Disqus</h1>
<p><a href="http://disqus.com/"><img style="float: right; margin: 5px; display: inline" src="https://a.disquscdn.com/dotcom/d-e357401/img/logos/logo-navbar-blue.png" align="right" /></a>I’m surprised how well that <a href="/12548">my commentRss proposal</a> has been accepted in the world. As often as not, if I’m digging through an RSS feed for a site that supports comments, that site also provides a commentRss element for each item. When I proposed this element, my thinking was that I could make a comment on an item of interest, then check a box and I’d see async replies in my RSS client, thereby fostering discussion. Unfortunately, RSS clients never took the step of allowing me to subscribe to comments for a particular item and a standard protocol for adding a comment never emerged, which made it even less likely for RSS clients to add that check box. All in all, commentRss is a failed experiment.</p>  <h2>Fostering Discussion in Blog Post Comments</h2>  <p>However, the idea of posting comments to a blog post and subscribing to replies took off in another way. For example, Facebook does a very good job in fostering discussion on content posted to their site:</p>  <p><a href="/public/post-images/12734-248.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12734-249.png" width="591" height="768" /></a></p>  <p><em>The Facebook supports comments and discussions nicely</em></p>  <p>&#160;</p>  <p>Not only does Facebook provide a nice UI for comments, but as I reply to comments that others have made, they’re notified. In fact, as I was taking the screenshot above, I replied to Craig’s comment and within a minute he’d pressed the Like button, all because of the support Facebook has for reply notification.</p>  <p>However, Facebook commenting only works for Facebook content. I want the same kind of experience with my own site’s content. For a long time, I had my own custom commenting system, but the bulk of the functionality was around keeping spam down, which was a huge problem. I recently dumped my comments to an XML format and of the 60MB of output, less than 8MB were actual comments – more than 80% was comment spam. I tried added <a href="http://www.google.com/recaptcha/intro/index.html">reCAPTCHA</a> and eventually email approval of all comments, but none of that fostered the back-and-forth discussions over time because I didn’t have notifications. Of course, to implement notifications, you need user accounts with email verification, which was a whole other set of features that I just never got around to implementing. And even if I did, I would have taken me a lot more effort to get to the level of quality that <a href="http://www.disqus.com/">Disqus</a> provides.</p>  <h2>Integrating Disqus Into Your Web Site</h2>  <p>Disqus provides a service that lets me import, export and manage comments for my site’s blog posts, the UI for my web site to collect and display comments and the notification system that fosters discussions. And they watch for spam, too. Here’s what it looks like on a recent post on my site:</p>  <p><a href="/public/post-images/12734-250.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12734-251.png" width="646" height="367" /></a></p>  <p><em>The Disqus services provides a discussion UI for your web site</em></p>  <p>&#160;</p>  <p>Not only does Disqus provide the UI for comments, but it also provides the account management so that commenters can have icons and get notifications. With the settings to allow for guest posting, the barrier to entry for the reader that wants to leave a comment is zero. Adding the code to enable it on your site isn’t zero, but it’s pretty close. Once you’ve established a free account on <a href="http://disqus.com/admin/create/">disqus.com</a>, you can simply create a forum for your site and drop in some boilerplate code. Here’s what I added to my MVC view for a post’s detail page to get the discussion section above:</p>  <pre class="code"><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: #006400">-- Details.aspx –</span><span style="background: yellow; color: black">%&gt;</span></pre>

<pre class="code"><span style="background: white; color: black">...
</span><span style="background: white; color: blue">&lt;</span><span style="background: white; color: maroon">asp</span><span style="background: white; color: blue">:</span><span style="background: white; color: maroon">Content </span><span style="background: white; color: red">ID</span><span style="background: white; color: blue">=&quot;Content2&quot; </span><span style="background: white; color: red">ContentPlaceHolderID</span><span style="background: white; color: blue">=&quot;MainContent&quot; </span><span style="background: white; color: red">runat</span><span style="background: white; color: blue">=&quot;server&quot;&gt;
</span><span style="background: white; color: blue"><span style="background: white; color: black"> </span> </span><span style="background: white; color: #006400">&lt;!-- post –&gt;
</span><span style="background: white; color: black">  ...</span></pre>

<pre class="code"><span style="background: white; color: black"></span><span style="background: white; color: blue">  &lt;</span><span style="background: white; color: maroon">h1</span><span style="background: white; color: blue">&gt;</span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">Model.Post.Title </span><span style="background: yellow; color: black">%&gt;</span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">h1</span><span style="background: white; color: blue">&gt;
  &lt;</span><span style="background: white; color: maroon">div</span><span style="background: white; color: blue">&gt;</span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">Model.Post.Content </span><span style="background: yellow; color: black">%&gt;</span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">div</span><span style="background: white; color: blue">&gt;
<strong>  </strong></span><strong><span style="background: white; color: #006400">&lt;!-- comments --&gt;
  </span><span style="background: white; color: blue">&lt;</span><span style="background: white; color: maroon">div </span><span style="background: white; color: red">id</span><span style="background: white; color: blue">=&quot;disqus_thread&quot;&gt;&lt;/</span><span style="background: white; color: maroon">div</span></strong><strong><span style="background: white; color: blue">&gt;
  &lt;</span><span style="background: white; color: maroon">script </span><span style="background: white; color: red">type</span></strong><strong><span style="background: white; color: blue">=&quot;text/javascript&quot;&gt;
    var </span><span style="background: white; color: black">disqus_shortname = </span><span style="background: white; color: #a31515">&quot;YOUR-DISQUS-SITE-SHORTNAME-HERE&quot;</span></strong><strong><span style="background: white; color: black">;
    </span><span style="background: white; color: blue">var </span><span style="background: white; color: black">disqus_identifier = </span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">Model.Post.Id </span><span style="background: yellow; color: black">%&gt;</span></strong><strong><span style="background: white; color: black">;
    </span><span style="background: white; color: blue">var </span><span style="background: white; color: black">disqus_title = </span><span style="background: white; color: #a31515">&quot;</span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">Model.Post.Title </span><span style="background: yellow; color: black">%&gt;</span><span style="background: white; color: #a31515">&quot;</span></strong><strong><span style="background: white; color: black">;</span></strong><span style="background: white; color: black"><strong>

    </strong></span><strong><span style="background: white; color: green">/* * * DON'T EDIT BELOW THIS LINE * * */
    </span><span style="background: white; color: black">(</span><span style="background: white; color: blue">function </span></strong><strong><span style="background: white; color: black">() {
      </span><span style="background: white; color: blue">var </span><span style="background: white; color: black">dsq = document.createElement(</span><span style="background: white; color: #a31515">'script'</span><span style="background: white; color: black">); dsq.type = </span><span style="background: white; color: #a31515">'text/javascript'</span><span style="background: white; color: black">; dsq.async = </span><span style="background: white; color: blue">true</span></strong><strong><span style="background: white; color: black">;
      dsq.src = </span><span style="background: white; color: #a31515">'//' </span><span style="background: white; color: black">+ disqus_shortname + </span><span style="background: white; color: #a31515">'.disqus.com/embed.js'</span></strong><strong><span style="background: white; color: black">;
      (document.getElementsByTagName(</span><span style="background: white; color: #a31515">'head'</span><span style="background: white; color: black">)[0] || document.getElementsByTagName(</span><span style="background: white; color: #a31515">'body'</span></strong><strong><span style="background: white; color: black">)[0]).appendChild(dsq);
    })();
  </span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">script</span></strong><span style="background: white; color: blue"><strong>&gt;
</strong>&lt;/</span><span style="background: white; color: maroon">asp</span><span style="background: white; color: blue">:</span><span style="background: white; color: maroon">Content</span><span style="background: white; color: blue">&gt;
</span></pre>

<p>The discussion section for any post is just a div with the id set to “disqus_thread”. The code is from the useful-but-difficult-to-find <a href="https://help.disqus.com/customer/portal/articles/472097-universal-embed-code">Disqus universal embed code docs</a>. The JavaScript added to the end of the page creates a Disqus discussion control in the div you provide using the JS variables defined at the top of the code. The only JS variable that’s required is the disqus_shortname, which defines the Disqus data source for your comments. The disqus_identifier is a unique ID associated with the post. If this isn’t provided, the URL for the page the browser is currently showing will be used, but that doesn’t work for development mode from localhost or if the comments are hosted on multiple sites, e.g. a staging server and a production server, so I recommend setting disqus_identifier explicitly. The disqus_title will likewise be taken from the current page’s title, but it’s better to set it yourself to make sure it’s what you want.</p>

<p>And that’s it. Instead of tuning your UI in the JS code, you do so in the settings on disqus.com yourself an includes things like the default order of comments, the color scheme, how much moderation you want, etc.</p>

<p>There’s one more page on your site where you’ll want to integrate Disqus: the page the provides the list of posts along with the comment link and comment count:</p>

<p><a href="/public/post-images/12734-252.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12734-253.png" width="646" height="393" /></a></p>

<p><em>Disqus will add comment count to your comment lists, too</em></p>

<p>&#160;</p>

<p>Adding support for the comment count is similar to adding support for the discussion itself:</p>

<pre class="code"><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: #006400">-- Index.aspx --</span><span style="background: yellow; color: black">%&gt;
</span><span style="background: white; color: blue">...</span></pre>

<pre class="code"><span style="background: white; color: blue">&lt;</span><span style="background: white; color: maroon">asp</span><span style="background: white; color: blue">:</span><span style="background: white; color: maroon">Content </span><span style="background: white; color: red">ID</span><span style="background: white; color: blue">=&quot;Content2&quot; </span><span style="background: white; color: red">ContentPlaceHolderID</span><span style="background: white; color: blue">=&quot;MainContent&quot; </span><span style="background: white; color: red">runat</span><span style="background: white; color: blue">=&quot;server&quot;&gt;
<span style="background: white; color: blue">  ...</span></span></pre>

<pre class="code"><span style="background: white; color: #006400">  &lt;!-- post --&gt;
</span><span style="background: white; color: blue">  &lt;</span><span style="background: white; color: maroon">h2</span><span style="background: white; color: blue">&gt;</span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">Html.ActionLink(post.Title, </span><span style="background: white; color: #a31515">&quot;Details&quot;</span><span style="background: white; color: black">, </span><span style="background: white; color: #a31515">&quot;Posts&quot;</span><span style="background: white; color: black">, </span><span style="background: white; color: blue">new </span><span style="background: white; color: black">{ id = post.Id }, </span><span style="background: white; color: blue">null</span><span style="background: white; color: black">) </span><span style="background: yellow; color: black">%&gt;</span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">h2</span><span style="background: white; color: blue">&gt;
  &lt;</span><span style="background: white; color: maroon">p</span><span style="background: white; color: blue">&gt;</span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">post.Content </span><span style="background: yellow; color: black">%&gt;</span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">p</span><span style="background: white; color: blue">&gt;
<span style="background: white; color: #006400"><strong>  &lt;!-- comment link --&gt; </strong></span></span></pre>

<pre class="code"><span style="background: white; color: blue"><span style="background: white; color: #006400"></span><strong>  &lt;</strong></span><strong><span style="background: white; color: maroon">p</span><span style="background: white; color: blue">&gt;</span><span style="background: yellow; color: black">&lt;%</span><span style="background: white; color: blue">= </span><span style="background: white; color: black">Html.ActionLink(</span><span style="background: white; color: #a31515">&quot;0 comments&quot;</span><span style="background: white; color: black">, </span><span style="background: white; color: #a31515">&quot;Details&quot;</span><span style="background: white; color: black">, </span><span style="background: white; color: #a31515">&quot;Posts&quot;</span><span style="background: white; color: black">, </span><span style="background: white; color: blue">null</span><span style="background: white; color: black">, </span><span style="background: white; color: blue">null</span><span style="background: white; color: black">, </span><span style="background: white; color: #a31515">&quot;disqus_thread&quot;</span><span style="background: white; color: black">,<br /></span></strong><strong><span style="background: white; color: black">           </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">RouteValueDictionary</span><span style="background: white; color: black">(<br /></span></strong><strong><span style="background: white; color: black">             </span><span style="background: white; color: blue">new </span><span style="background: white; color: black">{ id = post.Id }),<br /></span></strong><strong><span style="background: white; color: black">             </span><span style="background: white; color: blue">new </span><span style="background: white; color: #2b91af">Dictionary</span><span style="background: white; color: black">&lt;</span><span style="background: white; color: blue">string</span><span style="background: white; color: black">, </span><span style="background: white; color: blue">object</span><span style="background: white; color: black">&gt;() { { </span><span style="background: white; color: #a31515">&quot;data-disqus-identifier&quot;</span><span style="background: white; color: black">, post.Id } }) </span><span style="background: yellow; color: black">%&gt;</span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">p</span></strong><span style="background: white; color: blue"><strong>&gt;
</strong><span style="background: white; color: blue">  ...</span></span></pre>

<pre class="code"><span style="background: white; color: blue"><span style="background: white; color: blue"></span></span><strong><span style="background: white; color: blue">  &lt;</span><span style="background: white; color: maroon">script </span><span style="background: white; color: red">type</span></strong><span style="background: white; color: blue"><strong>=&quot;text/javascript&quot;&gt;
    </strong></span><strong><span style="background: white; color: green">// from: https://help.disqus.com/customer/portal/articles/565624
    </span><span style="background: white; color: blue">var </span><span style="background: white; color: black">disqus_shortname = </span><span style="background: white; color: #a31515">&quot;sellsbrothers&quot;</span></strong><span style="background: white; color: black"><strong>;

    </strong></span><strong><span style="background: white; color: green">/* * * DON'T EDIT BELOW THIS LINE * * */
    </span><span style="background: white; color: black">(</span><span style="background: white; color: blue">function </span></strong><strong><span style="background: white; color: black">() {
      </span><span style="background: white; color: blue">var </span><span style="background: white; color: black">s = document.createElement(</span><span style="background: white; color: #a31515">'script'</span><span style="background: white; color: black">); s.async = </span><span style="background: white; color: blue">true</span></strong><strong><span style="background: white; color: black">;
      s.type = </span><span style="background: white; color: #a31515">'text/javascript'</span></strong><strong><span style="background: white; color: black">;
      s.src = </span><span style="background: white; color: #a31515">'http://' </span><span style="background: white; color: black">+ disqus_shortname + </span><span style="background: white; color: #a31515">'.disqus.com/count.js'</span></strong><strong><span style="background: white; color: black">;
      (document.getElementsByTagName(</span><span style="background: white; color: #a31515">'HEAD'</span><span style="background: white; color: black">)[0] || document.getElementsByTagName(</span><span style="background: white; color: #a31515">'BODY'</span></strong><strong><span style="background: white; color: black">)[0]).appendChild(s);
    }());
  </span><span style="background: white; color: blue">&lt;/</span><span style="background: white; color: maroon">script</span></strong><span style="background: white; color: blue"><strong>&gt;
</strong>&lt;/</span><span style="background: white; color: maroon">asp</span><span style="background: white; color: blue">:</span><span style="background: white; color: maroon">Content</span><span style="background: white; color: blue">&gt;
</span></pre>

<p>Again, this code is largely boilerplate and comes from <a href="https://help.disqus.com/customer/portal/articles/565624">the Disqus comment count docs</a>. The call to Html.ActionLink is just a fancy way to get an A tag with an href of the following format:</p>

<blockquote>
  <p>&lt;a href=&quot;/Posts/Details/&lt;&lt;POST-ID&gt;&gt;<strong>#disqus_thread</strong>&quot; <strong>data-disqus-identifier=&quot;&lt;&lt;POST-ID&gt;&gt;&quot;</strong>&gt;<strong>0 comments</strong>&lt;/a&gt;</p>
</blockquote>

<p>The “disqus_thread” tag at the end of the href does two things. The first is that it provides a link to the discussion portion of the details page so that the reader can scroll directly to the comments after reading the post. The second is that it provides a tag for the Disqus JavaScript code to change the text content of the A tag to show the number of comments.</p>

<p>The “data-disqus-identifier” attribute sets the unique identifier for the post itself, just like the disqus_identifier JS variable we saw earlier.</p>

<p>The A tag text content that you provide will only be shown if Disqus does not yet know about that particular post, i.e. if there are no comments yet, then it will leave it alone. However, if Disqus does know about that post, it will replace the text content of the A tag as per your settings, which allow you to be specific about how you want 0, 1 and n comments to show up on your site; “0 comments”, “1 comment” and “{num} comments” are the defaults. </p>

<h2>Importing Existing Comments into Disqus</h2>

<p>At this point, your site is fully enabled for Disqus discussions and you can deploy. In the meantime, if you’ve got existing comments like I did, you can import them using Disqus’s implementation of the WordPress WXR format, which is essentially RSS 2.0 with embedded comments. <a href="https://help.disqus.com/customer/portal/articles/472150">The Disqus XML import docs</a> describe the format and some important reminders. The two reminders they list are important enough to list again here:</p>

<ul>
  <li><strong>“Register a test forum and import to that forum first to work out the kinks.” </strong>Because Disqus only lists some of the restrictions on their site for the imported data, I probably had to do a dozen or more imports before I get everything to move over smoothly. I ended up using two test forums before I was confident enough to import comments into my the real forum for my site. </li>

  <li><strong>“Keep individual file sizes &lt; 50 MB each.”</strong> In fact, I found 20MB to be the maximum reliable size. I had to write my script to split my comments across multiple files to keep to this limit or my uploads would time out. </li>
</ul>

<p>&#160;</p>

<p>The XML import docs do a good job showing what the XML format is as an example, but they only list one of the data size requirements. In my work, I found several undocumented limits as well:</p>

<ul>
  <li><strong>comment_content must be &gt;= 3 characters (space trimmed) and &lt;= 25,000 characters. </strong>I found out the max when trying to import some of my unapproved spam comments. </li>

  <li><strong>comment_author and comment_author_email must be &lt;= 75 characters. </strong>You may get errors about comment_author being too long even if you haven’t provided one; that just means that Disqus has grabbed comment_author_email as the contents for comment_author. </li>

  <li><strong>post_date_gmt and comment_date_gmt</strong> <strong>must be formatted correctly as yyyy-MM-dd HH:mm:ss. </strong>Of course, they must be in GMT, too. </li>

  <li><strong>The actual post content should be empty.</strong> Even though it looks like you’re uploading your entire blog via RSS, you’re only providing enough of the post content to allow Disqus to map from post to associated comments, like the thread_identifier referenced as disqus_thread in the JavaScript code above, as well as to show the post title and date as appropriate. The only real content you’re importing into Disqus is the comment content associated with each post. </li>
</ul>

<p>Something else to keep in mind is that as part of the comment import process is that Disqus translates the XML data into JSON data, which makes sense. However, they report their errors in terms of the undocumented JSON data structure, which can be confusing as hell. For example, I kept getting a “missing or invalid message” error message along with the JSON version of what I thought the message was to which they were referring. The problem was that by “message”, Disqus didn’t mean “the JSON data packet for a particular comment,” they meant “the field called ‘message’ in our undocumented JSON format which is mapped from the comment_content element of the XML.” I went round and round with support on this until I figured that out. Hopefully I’ve saved future generations that trouble.</p>

<p>If you’re a fan of LINQPad or C#, you can see <a href="https://github.com/csells/sb4/blob/master/Solution%20Items/sb-com%20creating%20WXR%20file%20for%20Disqus%20comment%20export.linq">the script I used to pull the posts and comments out of my site’s SQL Server database</a> (this assumes an Entity Framework mapping in a separate DLL, but you get the gist). The restrictions I mention above are encapsulated in this script.</p>

<h2>Where Are We?</h2>

<p>Even though my rssComments extension to the RSS protocol was a failed experiment, the web has figured out how to foster spam-free, interactive discussions with email notifications across web sites. The free Disqus service provides as implementation of this idea and it does so beautifully. I wish importing comments was as easy as integrating the code, but since I only had to do it once, the juice was more than worth the squeeze, as <a href="http://michaelweinhardtphotography.com/">a dear Australian friend of mine</a> likes to say. Enjoy!</p>  
