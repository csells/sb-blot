<!--
Date: 7/7/2014 2:45:05 AM  -08:00
Permalink: 12731
Disqus: 12731
Tags: spout
-->
<h1>Moving My Site to Azure: The Database</h1>
<p><a href="https://www.youtube.com/watch?v=PjWKE-IJ4R8">In a world</a> where the cloud is not longer the wave of the future, but the reality of the present, it seems pretty clear that it’s time to move <a href="/">sellsbrothers.com</a> from my free ISP hosting (thanks <a href="http://securewebs.com/">securewebs.com</a>!) to the cloud, specially Microsoft’s Azure. Of course, I’ve had an Azure account since its inception, but there has been lots of work to streamline the Azure development process in the last two years, so now should be the ideal time to jump in and see how blue the waters really are.</p>  <p>As with any modern web property, I’ve got three tiers: presentation, service and database. Since the presentation tier uses server-side generated UI and it’s implementation is bundled together with the service tier, there are two big pieces to move – the ASP.NET site implementation and the SQL Server database instance. I decided to move the database first with the idea that once I got it hosted on Azure, I can simply flip the connection string to point the existing site to the new instance while I was doing the work to move the site separately.</p>  <h2>Deploy Database To Windows Azure SQL Database from SSMS</h2>  <p>The database for my site does what you’d expect – it keeps track of the posts I make (like this one), the images that go along with each post, the comments that people make on each post, the writing and talks I give (shown on <a href="/writing">the writing page</a>), book errata, some details about the navigation of the site, etc. In SQL Server Management Studio (SSMS), it looks pretty much like you’d expect:</p>  <p><a href="/public/post-images/12731-190.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-191.png" width="644" height="476" /></a></p>  <p><em>sellsbrothers.com loaded into SQL Server Management Studio</em></p>  <p>&#160;</p>  <p>However, before moving to Azure SQL Server, I needed a SQL Azure instance to move the data to, so I fired up <a href="https://manage.windowsazure.com">the Azure portal</a> and created one:</p>  <p><a href="/public/post-images/12731-192.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-193.png" width="644" height="296" /></a></p>  <p><em>Creating a new SQL Azure database</em></p>  <p>&#160;</p>  <p>In this case, I chose to create a new SQL Azure instance on a new machine, which Azure will spin up for us in a minute of two (and hence the wonder and beauty that is the cloud). I choose the Quick Create option instead of the Import option because the Import option required me to provide a .bacpac file, which was something I wasn’t familiar with. After creating the SQL Server instance and the corresponding server, clicking on the new server name (di5fa5p2lg in this case) gave me the properties of that server, including the Manage URL:</p>  <p><a href="/public/post-images/12731-194.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-195.png" width="644" height="330" /></a></p>  <p><em>SQL Azure database properties</em></p>  <p>&#160;</p>  <p>If you click on the Manage URL, you will have a web interface for interacting with your SQL Azure server, but more importantly for this exercise, the <a href="http://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a> is what I needed to plug into SSMS so that I can connect to that server. I’ll need that in a minute, because in the meantime, I’d discovered what looked like the killer feature for my needs in the 2014 edition of SSMS:</p>  <p><a href="/public/post-images/12731-196.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-197.png" width="644" height="209" /></a></p>  <p><em>Deploy Database to Windows Azure Database in SSMS 2014</em></p>  <p>&#160;</p>  <p>By right-clicking on the database on my ISP in SSMS and choosing Tasks, I had the Deploy Database To Windows Azure SQL Database option. I was so happy to choose this option and see the Deployment Settings screen of the Deploy Database dialog:</p>  <p><a href="/public/post-images/12731-198.png"><img title="Untitled-2" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Untitled-2" src="/public/post-images/12731-199.png" width="540" height="484" /></a></p>  <p><em>SSMS Deploy Database dialog</em></p>  <p>&#160;</p>  <p>Notice the Server connection is filled in with the name of my new SQL Server instance on Azure. It started blank and I filled it in by pushing the Connect button:</p>  <p><a href="/public/post-images/12731-200.png"><img title="Untitled-7" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Untitled-7" src="/public/post-images/12731-201.png" width="644" height="469" /></a></p>  <p><em>SSMS Connect to Server dialog</em></p>  <p>&#160;</p>  <p>The Server name field of the Connect to Server dialog is where the FQDN we pulled from the Manage URL field of Azure database server properties screen earlier and the credentials are the same as I set when I created the database. However, filling in this dialog for the first time gave me some trouble:</p>  <p><a href="/public/post-images/12731-202.png"><img title="Untitled-8" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Untitled-8" src="/public/post-images/12731-203.png" width="644" height="254" /></a></p>  <p><em>SQL Azure: Cannot open server ‘foo’ requested by the login</em></p>  <p>&#160;</p>  <p>SQL Azure is doing the right thing here to keep your databases secure by disabling access to any machine that’s not itself managed by Azure. To enable access from your client, look for the “Set up Windows Azure firewall rules for this IP address” option on the SQL database properties page in your Azure portal. You’ll end up with a server firewall rule that looks like the following (and that you may want to remove when you’re done with it):</p>  <p><a href="/public/post-images/12731-204.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-205.png" width="644" height="250" /></a></p>  <p><em>SQL Azure server firewall rules</em></p>  <p>&#160;</p>  <p>Once the firewall has been configured, filling in the connection properties and starting the database deployment from my ISP to Azure was when my hopes and dreams were crushed:</p>  <p><a href="/public/post-images/12731-206.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-207.png" width="644" height="256" /></a></p>  <p><em>SSMS Deploy Database: Operation Failed</em></p>  <p>&#160;</p>  <p>Clicking on the Error links all reported the same thing:</p>  <p><a href="/public/post-images/12731-208.png"><img title="Untitled-4" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Untitled-4" src="/public/post-images/12731-209.png" width="644" height="203" /></a></p>  <p><em>Error validating element dt_checkoutobject: Deprecated feature ‘String literals as column aliases’ is not supported by SQL Azure</em></p>  <p>&#160;</p>  <p>At this point, all I could think was “what the heck is dt_checkoutobject” (<a href="http://social.msdn.microsoft.com/Forums/sqlserver/en-US/200ea417-f798-40e6-97a7-3ed8b174d962/mysterious-stored-procedures?forum=sqltools">it’s something that Microsoft added to my database</a>), what does it mean for to use string literals as column aliases (it’s a <a href="http://stackoverflow.com/questions/16284012/no-longer-able-to-create-a-bacpac-sql70015-deprecated-feature-string-literals/16284161#16284161">deprecated feature that SQL Azure doesn’t support</a>) and why would Microsoft deprecate a feature that they used themselves on a stored proc that they snuck into my database?! Unfortunately, we’ll never know the answer to that last question. However, my righteous indignation went away as I dug into my schema and found several more features that SQL Azure doesn’t support that I put into my own schema (primarily it was the lack of clustered indexes for primary keys, which <a href="http://blogs.msdn.com/b/sqlazure/archive/2010/05/12/10011257.aspx">SQL Azure requires to keep replicas of your database in the cloud</a>). Even worse, I found one table that listed errata for my books that didn’t have a primary key at all and because no one was keeping track of data integrity, all of the data was in that table twice (I can’t blame THAT on Microsoft : ).</p>  <p>And just in case you think you can get around these requirements and sneak your database into SQL Azure w/o the updates, manually importing your data using <a href="http://blogs.msdn.com/b/brunoterkaly/archive/2013/09/26/how-to-export-an-on-premises-sql-server-database-to-windows-azure-storage.aspx">a bacpac file</a> is even harder, since you now have to make the changes to your database before you can create the bacpac file and you have to upload the file to Azure’s blob storage, which requires <a href="http://azurestorageexplorer.codeplex.com/">a whole other tool that Microsoft doesn’t even provide</a>.</p>  <h2>Making your Database SQL Azure-compatible using Visual Studio</h2>  <p>To make my SQL database compatible with SQL Azure required changing the schema for my database. Since I didn’t want to change the schema for a running database on my ISP, I ended up copying the database from my ISP onto my local machine and making my schema changes there. Getting to point of SQL Azure-compatibility, however, required me to have the details of which SQL constructs SQL Azure supported and didn’t support. Microsoft provides <a href="http://msdn.microsoft.com/en-us/library/azure/ee336245.aspx">overview guidance on the limitations of SQL Azure</a>, but it’s not like having an automated tool that can check every line of your SQL. Luckily, Microsoft provides such a tool built into Visual Studio.</p>  <p>To bring Microsoft’ SQL compiler to bear to check for SQL Azure compatibility requires using VS to create a SQL Server Database Project and then pointing it at the database you’d like to import from (which is the one copied to my local machine from my ISP in my case). After you’ve imported your database’s schema, doing a build will check your SQL for you. To get VS to check your SQL for Azure-compatibility, simply bring up the project settings and choose Windows Azure SQL Database as the Target platform:</p>  <p><a href="/public/post-images/12731-210.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-211.png" width="644" height="356" /></a></p>  <p><em>Visual Studio 2014: Setting Database Project Target Platform</em></p>  <p>&#160;</p>  <p>With this setting in place, compiling your project will tell you what’s wrong with your SQL from an Azure point-of-view. Once you’ve fixed your schema (which may require fixing your data, too), then you can generate a change script that updates your database in-place to make it Azure-compatible. For more details, check out Bill Gibson’s excellent article <a href="http://blogs.msdn.com/b/ssdt/archive/2012/04/19/migrating-a-database-to-sql-azure-using-ssdt.aspx">Migrating a Database to SQL Azure using SSDT</a>.</p>  <h2>The Connection String</h2>  <p>Once the database has been deployed and tested (SSMS or the Manage URL are both good ways to test that your data is hosted the way you think it should be), then it’s merely a matter of changing the connection string to point to the SQL Azure instance. You can compose the connection string yourself or you can choose the “View connection strings for ADO.NET, ODBC, PHP and JDBC” option from your database properties page on Azure:</p>  <p><a href="/public/post-images/12731-212.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="/public/post-images/12731-213.png" width="642" height="417" /></a></p>  <p><em>SQL Azure: Connection Strings</em></p>  <p>&#160;</p>  <p>You’ll notice that while I blocked out some of the details of the connection string in my paranoia, that Azure itself is too paranoid to show the password; don’t forget to insert it yourself and to put it into a .config file that doesn’t make it into the SCCS.</p>  <h2></h2>  <h2>Where are we?</h2>  <p>In porting sellsbrothers.com from an ISP to Azure, I started with the database. The tools are there (nice tools, in fact), but you’ll need to make sure that your database schema is SQL Azure-compatible, which can take some doing. In <a href="/12732">the next installment</a>, I’ll talk about how I moved the implementation of the site itself, which was not trivial, as it is implemented in ASP.NET MVC 2, which has been long abandoned by Microsoft.</p>  <p>If you’d like to check out the final implementation in advance of my next post, you help yourself to <a href="https://github.com/csells/sb4">the sellsbrothers.com project on github</a>. Enjoy.</p>  
