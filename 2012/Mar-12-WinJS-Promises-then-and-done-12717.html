<!--
Date: 3/12/2012 8:03:49 AM  -08:00
Permalink: 12717
Disqus: 12717
Tags: telerik,win8,telerik,win8
-->
<h1>WinJS Promises: then and done</h1>
<p>As of the Windows Consumer Preview (aka Win8 Beta), the WinJS promises object has a “done” method as well as a “then” method. The “done” method is just like “then” except that it turns unhandled errors into exceptions. If you read no further, know this:</p>  <p><strong>Always call “done” as the last promise method in your promise chain.</strong></p>  <p>Let’s say you have a <a href="http://msdn.microsoft.com/en-us/library/windows/apps/br211867.aspx">promise</a> implementation that makes failure a strong possibility:</p>  <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:78146b93-03d5-4e1a-9e89-1d88ab88db3c" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="background:#ffffff;color:#0000ff">var</span><span style="background:#ffffff;color:#000000"> prom = </span><span style="background:#ffffff;color:#0000ff">new</span><span style="background:#ffffff;color:#000000"> WinJS.Promise(</span><span style="background:#ffffff;color:#0000ff">function</span><span style="background:#ffffff;color:#000000"> (c, e, p) { e(</span><span style="background:#ffffff;color:#a31515">&quot;#fail&quot;</span><span style="background:#ffffff;color:#000000">); });</span></li> </ol> </div> </div> </div>  <p>A fastidious developer will always pass in an error handler whenever then call the “then” method of a promise:</p>  <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:b19317ab-24e4-4517-bcda-0119bfa583f2" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="background:#ffffff;color:#000000">prom.then(..., </span><span style="background:#ffffff;color:#0000ff">function</span><span style="background:#ffffff;color:#000000"> (m) { content.innerText = </span><span style="background:#ffffff;color:#a31515">&quot;Handled: &quot;</span><span style="background:#ffffff;color:#000000"> + m; });</span></li> </ol> </div> </div> </div>    <p>However, in the case that the developer doesn’t pass in a error handler function when calling “then”, the error will silently drop on the floor:</p>  <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:b993e38a-3fb0-449a-99c6-290039f32525" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="background:#ffffff;color:#000000">prom.then(); </span><span style="background:#ffffff;color:#008000">// error? what error?</span></li> </ol> </div> </div> </div>  <p>I realize that the web was built around the idea that page errors should just silently whistle into the wind, but as an app developer:</p>  <p><strong>Errors should be loud.</strong></p>  <p>So, I want my errors to be loud, I should default to using the “done” method on a promise instead:</p>  <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:4258e7c2-86b7-4b6a-a1e6-2435a97525e0" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="background:#ffffff;color:#000000">prom.done(); </span><span style="background:#ffffff;color:#008000">// error == BOOM!</span></li> </ol> </div> </div> </div>  <p>When I call the “done” method and an unhandled error is detected, WinJS throws an error that not even a try-catch handler will stop from showing in the developer’s face:</p>  <p><a href="/public/post-images/12717-142.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="/public/post-images/12717-143.png" width="644" height="368" /></a></p>          <p>Personally, I’d prefer to be able to catch such errors in try-catch blocks, but this behavior is far preferable to the error being ignored. Of course, if I care that much, I can provide an error handler function when calling done:</p>  <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:73bbd372-5337-4803-a97f-f9f363a49f9e" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="background:#ffffff;color:#000000">prom.done(..., </span><span style="background:#ffffff;color:#0000ff">function</span><span style="background:#ffffff;color:#000000"> (m) { content.innerText = </span><span style="background:#ffffff;color:#a31515">&quot;Handled: &quot;</span><span style="background:#ffffff;color:#000000"> + m; });</span></li> </ol> </div> </div> </div>  <p>And finally, if I want to chain my promises, I just need to put the “then” methods in between so the errors flow, but the “done” method should always be last:</p>  <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:3dc3a217-b52c-4c06-a60c-0ef48d23a8a5" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#ffffff;color:#0000ff">var</span><span style="background:#ffffff;color:#000000"> app = WinJS.Application;</span></li> <li style="background: #f3f3f3"><span style="background:#ffffff;color:#000000">app.onactivated = </span><span style="background:#ffffff;color:#0000ff">function</span><span style="background:#ffffff;color:#000000"> (eventObject) {</span></li> <li>  <span style="background:#ffffff;color:#000000"></span><span style="background:#ffffff;color:#008000">// start the download</span></li> <li style="background: #f3f3f3">  <span style="background:#ffffff;color:#000000">downloadStatus.innerText = </span><span style="background:#ffffff;color:#a31515">&quot;downloading posts...&quot;</span><span style="background:#ffffff;color:#000000">;</span></li> <li>&nbsp;</li> <li style="background: #f3f3f3">  <span style="background:#ffffff;color:#000000"></span><span style="background:#ffffff;color:#008000">// process the declarative controls</span></li> <li>  <span style="background:#ffffff;color:#000000">WinJS.UI.processAll()</span></li> <li style="background: #f3f3f3">  <span style="background:#ffffff;color:#000000">.then(</span><span style="background:#ffffff;color:#0000ff">function</span><span style="background:#ffffff;color:#000000"> () {</span></li> <li>    <span style="background:#ffffff;color:#000000"></span><span style="background:#ffffff;color:#008000">// use the WinRT to download the RSS</span></li> <li style="background: #f3f3f3">    <span style="background:#ffffff;color:#000000"></span><span style="background:#ffffff;color:#0000ff">var</span><span style="background:#ffffff;color:#000000"> syn = </span><span style="background:#ffffff;color:#0000ff">new</span><span style="background:#ffffff;color:#000000"> Windows.Web.Syndication.SyndicationClient();</span></li> <li>    <span style="background:#ffffff;color:#000000"></span><span style="background:#ffffff;color:#0000ff">var</span><span style="background:#ffffff;color:#000000"> url = </span><span style="background:#ffffff;color:#0000ff">new</span><span style="background:#ffffff;color:#000000"> Windows.Foundation.Uri(</span><span style="background:#ffffff;color:#a31515">&quot;http://blogs.msdn.com/b/oldnewthing/rss.aspx&quot;</span><span style="background:#ffffff;color:#000000">);</span></li> <li style="background: #f3f3f3">    <span style="background:#ffffff;color:#000000"></span><span style="background:#ffffff;color:#0000ff">return</span><span style="background:#ffffff;color:#000000"> syn.retrieveFeedAsync(url);</span></li> <li>  <span style="background:#ffffff;color:#000000">})</span></li> <li style="background: #f3f3f3">  <span style="background:#ffffff;color:#000000">.done(processPosts, downloadError);</span></li> <li><span style="background:#ffffff;color:#000000">};</span></li> </ol> </div> </div> </div>  <p>This is actual code from an app that pulls down an RSS feed after the processAll method is completed in the “then” method on line 8, which returns another promise on line 12. That promise is handled by the “done” method on line 14. If there had been an error in the download and as a developer, I’d forgotten to provide the “downloadError” error handler, I’d have gotten a giant exception dialog that would’ve encouraged me down a different path.</p>  <p><em>Thanks to Josh Williams from the WinJS team for reminding me of the “done” method.</em></p>  
