<!--
Date: 2/4/2007 10:05:42 AM  -08:00
Permalink: 2079
Disqus: 2079
Tags: tools
-->
<h1>.NET: Decompressing zip file entries into memory</h1>
<P>I knew that the J# libraries in .NET had zip file support, but I couldn't find any samples that showed how to decompress the files into memory. The hard part, of course, is that the J# stream objects aren't the same as the .NET stream objects. If you're a Java programmer looking for a familiar library, that's great, but I'm not, so I had to do a little finagling.</P>
<P>The first thing you need to do is to add a reference to the vjslib assembly, which brings in .NET classes in Java namespaces, e.g. java.io. The one we care most about is java.uti.zip, which includes ZipFile and ZipEntry. We also need java.util for the Enumeration class and java.io for the InputStream class. With these in place, we can enumerate a zip file:</P>
<P><STRONG>using java.util; // all from vjslib assembly<BR>using java.util.zip;<BR>using java.io;<BR></STRONG>...<BR>static void Main(string[] args) {<BR>&nbsp; if( args.Length != 1 ) {<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine("Usage: dumpzipfileoftextfiles &lt;file&gt;");<BR>&nbsp;&nbsp;&nbsp; return;<BR>&nbsp; }</P>
<P>&nbsp; // we're assuming a zip file full of ASCII text files here<BR>&nbsp; string filename = args[0];<BR>&nbsp; ZipFile zip = new ZipFile(filename);</P>
<P>&nbsp; try {<BR><STRONG>&nbsp;&nbsp;&nbsp; // enumerate entries in the zip file<BR>&nbsp;&nbsp;&nbsp; // NOTE: can't enum via foreach -- Java objects don't support it<BR>&nbsp;&nbsp;&nbsp; Enumeration entries = zip.entries();<BR>&nbsp;&nbsp;&nbsp; while( entries.hasMoreElements() ) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ZipEntry entry = (ZipEntry)entries.nextElement();<BR></STRONG></P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // read text bytes into an ASCII string<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] bytes = ReadZipBytes(zip, entry);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string s = ASCIIEncoding.ASCII.GetString(bytes);</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do something w/ the text<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string entryname = entry.getName();<BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0}:\r\n{1}\r\n", entryname, s);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>&nbsp; finally {<BR><STRONG>&nbsp;&nbsp;&nbsp; if( zip != null ) { zip.close(); }<BR></STRONG>&nbsp; }<BR>}<BR></P>
<P>Notice the use of the Enumeration object so we can enumerate in the Java style and the use of the ZipFile and ZipEntry types. This is all stuff you could find in readily available online samples (I did). The interesting bit is the ReadZipBytes method:</P>
<P>static byte[] ReadZipBytes(ZipFile zip, ZipEntry entry) {<BR>&nbsp; // read contents of text stream into bytes<BR>&nbsp; InputStream instream = zip.getInputStream(entry);<BR>&nbsp; int size = (int)entry.getSize();<BR>&nbsp; sbyte[] sbytes = new sbyte[size];<BR><BR>&nbsp; // read all the&nbsp;bytes into memory<BR>&nbsp; int offset = 0;<BR>&nbsp; while( true ) {<BR>&nbsp;&nbsp;&nbsp; int read = instream.read(sbytes, offset, size - offset);<BR>&nbsp;&nbsp;&nbsp; if( read == -1 ) { break; }<BR>&nbsp;&nbsp;&nbsp; offset += read;<BR>&nbsp; }<BR>&nbsp; instream.close();</P>
<P><STRONG>&nbsp; // this is the magic method for converting signed bytes<BR>&nbsp; // in unsigned bytes for use with the rest of .NET, e.g.<BR>&nbsp; // Encoding.GetString(byte[]) or new MemoryStream(byte[])<BR>&nbsp; return (byte[])(object)sbytes;<BR></STRONG>}</P>
<P>For those of you familiar with Java, I'm just reading the zip file entry data into an array of signed bytes. However, most .NET APIs like unsigned bytes, e.g. "Encoding.GetString(byte[])" or "new MemoryStream(byte[])", which means you've got to convert a signed array of bytes in .NET to an unsigned array of bytes. Unfortunately, just casting doesn't work (the compiler complains). Even more unfortunately, I could find nothing in the Convert or BitConverter classes to perform this feat of magic and the code I wrote was dog slow, so I asked around internally.</P>
<P>Luckily, James Manning, an MS SDE, had the answer: cast the signed byte array to an object first and then to a unsigned byte array. Thank goodness James knew that, because I didn't find anything on this topic. Hopefully future generations will find this missive.</P>
<P>You can <a href="/public/samples/DumpZipFileOfTextFiles.zip">download the sample</A> if you like. Enjoy.</P>
